version: v1.0
name: Library API Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

blocks:
  - name: "Build & Test"
    dependencies: []
    task:
      jobs:
        - name: "Validar, Testar e Buildar"
          commands:
            - checkout
            - sem-version node 20
            - npm install
            
            # Sobe o banco (vai rodar na porta 3307 do localhost da VM)
            - docker-compose up -d
            - echo "Aguardando MySQL iniciar..."
            - sleep 20 

            # --- CORREÇÃO INFALÍVEL AQUI ---
            # Exportamos a variável diretamente no shell antes de usar
            - export DATABASE_URL="mysql://root:root@127.0.0.1:3307/library_db"
            # -------------------------------

            - npx prisma migrate dev --name init_ci
            - npx prisma generate

            - npm run build
            - npm test

  - name: "Deploy to Docker Hub"
    dependencies: ["Build & Test"]
    skip:
      when: "branch != 'main'"
    task:
      secrets:
        - name: docker-hub
      jobs:
        - name: Publicar Imagem
          commands:
            - checkout
            - echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
            - chmod +x deploy.sh
            - ./deploy.sh